<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>emotion_music_chatbot</title>
  <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ (ê°ì • íˆìŠ¤í† ë¦¬ ì‹œê°í™”ë¥¼ ìœ„í•´ ì‚¬ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
    }

    h2 {
      color: #333;
    }

    /* ë¡œê·¸ì¸/íšŒì›ê°€ì… ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    #loginCard, #signupCard {
      display: none;             
      background: none;
      border: none;
      padding: 0;
      margin-bottom: 20px;
      width: 100%;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
    .form-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .btn {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-sizing: border-box;
    }
    .btn + .btn {
      margin-top: 8px; /* ë²„íŠ¼ ê°„ ê°„ê²© */
    }

    #chatbox {
      width: 100%;
      max-width: 700px;
      height: 400px;
      border: 1px solid #000;
      border-radius: 8px;
      background-color: #fff;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 10px;
      display: none;
    }

    .message {
      margin: 10px 0;
      display: flex;
    }

    .user { justify-content: flex-end; }  /* ì‚¬ìš©ì ë©”ì‹œì§€ ì˜¤ë¥¸ìª½ ì •ë ¬ */
    .bot { justify-content: flex-start; } /* ì±—ë´‡ ë©”ì‹œì§€ ì™¼ìª½ ì •ë ¬ */

    .bubble {
      padding: 10px 15px;
      border-radius: 20px;
      max-width: 65%;
    }

    .user .bubble { background-color: #dcf8c6; color: #000; }
    .bot .bubble { background-color: #e6e6e6; color: #000; }

    #inputArea {
      display: none;
      justify-content: center;
      gap: 10px;
      width: 100%;
      max-width: 700px;
      margin-bottom: 20px;
    }

    #message {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #fff;
    }

    #sendBtn {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
    }

    /* ê°ì • íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ ì˜ì—­ */
    #chartContainer {
      width: 700px;
      display: none;
    }
  </style>
</head>
<body>
  <h2>emotion_music_chatbot</h2>

  <!-- ë¡œê·¸ì¸ ì´ë©”ì¼ + ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
  <div id="loginCard">
    <input class="form-input" id="loginEmail" placeholder="ì´ë©”ì¼">
    <input class="form-input" id="loginPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button class="btn" onclick="login()">ë¡œê·¸ì¸</button>
    <button class="btn" style="background-color:#6c757d;" onclick="showSignup()">íšŒì›ê°€ì…</button>
  </div>

  <!-- íšŒì›ê°€ì… -->
  <div id="signupCard">
    <input class="form-input" id="signupEmail" placeholder="ì´ë©”ì¼">
    <input class="form-input" id="signupPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <input class="form-input" id="signupNickname" placeholder="ë‹‰ë„¤ì„">
    <button class="btn" onclick="signup()">íšŒì›ê°€ì… ì™„ë£Œ</button>
  </div>

  <div id="chatbox"></div>

  <div id="inputArea">
    <input type="text" id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeydown="handleKey(event)">
    <button id="sendBtn" onclick="sendMessage()">ë³´ë‚´ê¸°</button>
  </div>

  <div id="chartContainer">
    <canvas id="emotionChart"></canvas>
  </div>

<script>
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ì¹´ë“œ í‘œì‹œ
  window.onload = () => {
    showLogin();
  };

  // ë¡œê·¸ì¸ ì¹´ë“œë§Œ ë³´ì´ë„ë¡ ì„¤ì •
  function showLogin() {
    document.getElementById("loginCard").style.display = "flex";
    document.getElementById("signupCard").style.display = "none";
  }

  // íšŒì›ê°€ì… ì¹´ë“œë§Œ ë³´ì´ë„ë¡ ì„¤ì •
  function showSignup() {
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("signupCard").style.display = "flex";
  }

  // ë¡œê·¸ì¸ ìš”ì²­ ì²˜ë¦¬
  async function login() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;

    const res = await fetch("/login", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (data.success) {
      initChatUI(); // ë¡œê·¸ì¸ ì„±ê³µ -> ì±„íŒ…ì°½ ì „í™˜
    } else if (data.message.includes("ë“±ë¡ë˜ì§€")) {
      document.getElementById("signupEmail").value = email;
      showSignup(); // ë“±ë¡ë˜ì§€ ì•Šì€ ê²½ìš° íšŒì›ê°€ì… í™”ë©´ìœ¼ë¡œ ì „í™˜
    } else {
      alert(data.message); // ê¸°íƒ€ ì˜¤ë¥˜ ì•Œë¦¼
    }
  }

  // íšŒì›ê°€ì… ìš”ì²­ ì²˜ë¦¬
  async function signup() {
    const email = document.getElementById("signupEmail").value;
    const password = document.getElementById("signupPassword").value;
    const nickname = document.getElementById("signupNickname").value;

    const res = await fetch("/signup", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ email, password, nickname })
    });

    const data = await res.json();

    if (data.success) {
      alert("íšŒì›ê°€ì… ì™„ë£Œ. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
      showLogin(); // íšŒì›ê°€ì… ì„±ê³µ -> ë¡œê·¸ì¸ í™”ë©´ ì „í™˜
    } else {
      alert(data.message);
    }
  }

  // ì±„íŒ… UI ì´ˆê¸°í™” (ë¡œê·¸ì¸ ì„±ê³µ ì‹œ)
  async function initChatUI() {
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("signupCard").style.display = "none";
    document.getElementById("chatbox").style.display = "block";
    document.getElementById("inputArea").style.display = "flex";
    document.getElementById("chartContainer").style.display = "block";
    await loadChart(); // ê°ì • íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ ë¡œë”©
  }

  // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
  async function sendMessage() {
    const input = document.getElementById("message");
    const chatbox = document.getElementById("chatbox");
    const userMessage = input.value.trim();
    if (!userMessage) return;

    // ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ ì¶œë ¥
    chatbox.innerHTML += `<div class="message user"><div class="bubble">${userMessage}</div></div>`;
    input.value = "";
    chatbox.scrollTop = chatbox.scrollHeight;

    try {
      // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
      const res = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message: userMessage })
      });

      const data = await res.json();

      // ì±—ë´‡ ì‘ë‹µ ì¶œë ¥
      chatbox.innerHTML += `<div class="message bot"><div class="bubble">${data.reply}</div></div>`;

      // ìŒì•… ì¶”ì²œì´ ìˆìœ¼ë©´ í•¨ê»˜ ì¶œë ¥
      if (data.song) {
        chatbox.innerHTML += `<div class="message bot"><div class="bubble">ğŸµ ${data.song.content}</div></div>`;
      }

      chatbox.scrollTop = chatbox.scrollHeight;
      await loadChart(); // ê°ì • ì°¨íŠ¸ ê°±ì‹ 
    } catch (e) {
      chatbox.innerHTML += `<div class="message bot"><div class="bubble">ì„œë²„ ì˜¤ë¥˜: ${e}</div></div>`;
    }
  }

  // Enter í‚¤ ì…ë ¥ ì‹œ ë©”ì‹œì§€ ì „ì†¡
  function handleKey(event) {
    if (event.key === "Enter") sendMessage();
  }

  // ê°ì • íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ ë¡œë“œ
  async function loadChart() {
    const res = await fetch("/emotion_history");
    const data = await res.json();
    if (!data.success) return;

    const history = data.history;
    const labels = Object.keys(history);

    // ê°ì • ì¢…ë¥˜ ìˆ˜ì§‘
    const emotionTypes = new Set();
    Object.values(history).forEach(day => {
      Object.keys(day).forEach(emo => emotionTypes.add(emo));
    });

    // ê°ì •ë³„ ë°ì´í„°ì…‹ ìƒì„±
    const datasets = [...emotionTypes].map(emotion => ({
      label: emotion,
      data: labels.map(date => history[date][emotion] || 0),
      backgroundColor: getEmotionColor(emotion)
    }));

    // ê°ì •ë³„ ìƒ‰ìƒ ì§€ì •
    function getEmotionColor(emotion) {
      const colors = {
        ê¸°ì¨: "#1E90FF",
        ìŠ¬í””: "#9E9E9E",
        ë¶„ë…¸: "#FF4500",
      };
      return colors[emotion] || "#777";
    }

    // ì°¨íŠ¸ ë Œë”ë§
    const ctx = document.getElementById("emotionChart").getContext("2d");
    if (window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "top" },
          title: { display: true, text: "ìµœê·¼ 7ì¼ ê°ì •ë³„ íˆìŠ¤í† ë¦¬" }
        },
        scales: {
          x: { stacked: true },
          y: { stacked: true }
        }
      }
    });
  }
</script>
</body>
</html>
