<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>emotion_music_chatbot</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
    }

    h2 {
      color: #333;
      margin-bottom: 10px;
    }

    /* Ïö∞Ï∏° ÏÉÅÎã® Î≤ÑÌäº */
    #topRightButton {
      position: absolute;
      top: 20px;
      right: 20px;
      display: none;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 14px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #loginCard, #signupCard {
      display: none;
      background: none;
      border: none;
      padding: 0;
      margin-bottom: 20px;
      width: 100%;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .form-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .btn {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-sizing: border-box;
    }

    .btn + .btn {
      margin-top: 8px;
    }

    #chatbox {
      width: 100%;
      max-width: 700px;
      height: 400px;
      border: 1px solid #000;
      border-radius: 8px;
      background-color: #fff;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 10px;
      display: none;
    }

    .message {
      margin: 10px 0;
      display: flex;
    }

    .user { justify-content: flex-end; }
    .bot { justify-content: flex-start; }

    .bubble {
      padding: 10px 15px;
      border-radius: 20px;
      max-width: 65%;
    }

    .user .bubble { background-color: #dcf8c6; color: #000; }
    .bot .bubble { background-color: #e6e6e6; color: #000; }

    #inputArea {
      display: none;
      justify-content: center;
      gap: 10px;
      width: 100%;
      max-width: 700px;
      margin-bottom: 20px;
    }

    #message {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #fff;
    }

    #sendBtn {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h2>emotion_music_chatbot</h2>

  <!-- Ïö∞Ï∏° ÏÉÅÎã® ÏãúÍ∞ÅÌôî Î≤ÑÌäº -->
  <div id="topRightButton">
    <button class="btn-small" onclick="goToVisualization()">Í∞êÏ†ï Í∏∞Î°ù Î≥¥Í∏∞</button>
  </div>

  <!-- Î°úÍ∑∏Ïù∏ -->
  <div id="loginCard">
    <input class="form-input" id="loginEmail" placeholder="Ïù¥Î©îÏùº">
    <input class="form-input" id="loginPassword" type="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏">
    <button class="btn" onclick="login()">Î°úÍ∑∏Ïù∏</button>
    <button class="btn" style="background-color:#6c757d;" onclick="showSignup()">ÌöåÏõêÍ∞ÄÏûÖ</button>
  </div>

  <!-- ÌöåÏõêÍ∞ÄÏûÖ -->
  <div id="signupCard">
    <input class="form-input" id="signupEmail" placeholder="Ïù¥Î©îÏùº">
    <input class="form-input" id="signupPassword" type="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏">
    <input class="form-input" id="signupNickname" placeholder="ÎãâÎÑ§ÏûÑ">
    <button class="btn" onclick="signup()">ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£å</button>
  </div>

  <div id="chatbox"></div>

  <div id="inputArea">
    <input type="text" id="message" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" onkeydown="handleKey(event)">
    <button id="sendBtn" onclick="sendMessage()">Î≥¥ÎÇ¥Í∏∞</button>
  </div>

  <script>
    window.onload = () => {
      showLogin();
    };

    function showLogin() {
      document.getElementById("loginCard").style.display = "flex";
      document.getElementById("signupCard").style.display = "none";
    }

    function showSignup() {
      document.getElementById("loginCard").style.display = "none";
      document.getElementById("signupCard").style.display = "flex";
    }

    async function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      const res = await fetch("/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();

      if (data.success) {
        initChatUI();
      } else if (data.message.includes("Îì±Î°ùÎêòÏßÄ")) {
        document.getElementById("signupEmail").value = email;
        showSignup();
      } else {
        alert(data.message);
      }
    }

    async function signup() {
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const nickname = document.getElementById("signupNickname").value;

      const res = await fetch("/signup", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ email, password, nickname })
      });

      const data = await res.json();

      if (data.success) {
        alert("ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£å. Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.");
        showLogin();
      } else {
        alert(data.message);
      }
    }

    async function initChatUI() {
      document.getElementById("loginCard").style.display = "none";
      document.getElementById("signupCard").style.display = "none";
      document.getElementById("chatbox").style.display = "block";
      document.getElementById("inputArea").style.display = "flex";
      document.getElementById("topRightButton").style.display = "block";
    }

    async function sendMessage() {
      const input = document.getElementById("message");
      const chatbox = document.getElementById("chatbox");
      const userMessage = input.value.trim();
      if (!userMessage) return;

      chatbox.innerHTML += `<div class="message user"><div class="bubble">${userMessage}</div></div>`;
      input.value = "";
      chatbox.scrollTop = chatbox.scrollHeight;

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ message: userMessage })
        });

        const data = await res.json();

        chatbox.innerHTML += `<div class="message bot"><div class="bubble">${data.reply}</div></div>`;
        if (data.song) {
          chatbox.innerHTML += `<div class="message bot"><div class="bubble">üéµ ${data.song.content}</div></div>`;
        }
        chatbox.scrollTop = chatbox.scrollHeight;
      } catch (e) {
        chatbox.innerHTML += `<div class="message bot"><div class="bubble">ÏÑúÎ≤Ñ Ïò§Î•ò: ${e}</div></div>`;
      }
    }

    function handleKey(event) {
      if (event.key === "Enter") sendMessage();
    }

    function goToVisualization() {
      window.location.href = "/visualization";
    }
  </script>
</body>
</html>
